%****************************************************************
\chapter{Flow Export Protocols}\label{ch:flow-export-protocols}
%****************************************************************

\section{NetFlow}\label{sec:netflow}
NetFlow \cite{rfc3954} by Cisco Systems is a protocol that allows network elements to export \ac{IP} flow information to designated collectors from where they can be later retrieved for further analyses. The collected flow-records are flexible enough to be used for a variety of purposes such as billing and mediation, network and user monitoring, resource provisioning, security analysis and data mining research works.  

\lstset{caption=A Flow Example, 
				tabsize=2, language=C, numbers=left,stepnumber=1,
				numberstyle=\ttfamily\color{gray}, keywordstyle=\color{blue},
				frame=shadowbox, rulesepcolor=\color{black}, 	
			  label=lst:flow-example, aboveskip=20pt, captionpos=b}
\begin{lstlisting}
(A) --> [SYN] ------>(B)
(A) <-- [SYN/ACK] <--(B)
(A) --> [ACK] ------>(B)
\end{lstlisting}
A flow is defined by a $7$-tuple flow-key, namely: \texttt{\{srcIP}, \texttt{dstIP}, \texttt{srcPort}, \texttt{dstPort}, \texttt{ipProto}, \texttt{ifIndex}, \texttt{ipTOS\}}. \ac{IP} packets with identical flow-keys become part of one flow. Two flows resulting from a three-way \ac{TCP} handshake for \marginpar{what is a flow?} example are shown in listing \ref{lst:flow-example}. In addition to the flow-key, flow-records can also contain additional accounting information such as flow start and end times, number of packets/octets in a flow, source/destination \ac{AS} numbers, et al.

\begin{figure}[h!]
\begin{center}
  \includegraphics* [width=0.7\linewidth]{figures/netflow-overview}	
  \caption{NetFlow: Overview \cite{nmelnikov:thesis:2010}}
  \label{fig:netflow-overview}
\end{center}
\end{figure}
A high-level abstracted functioning of the NetFlow protocol is shown in figure $\ref{fig:netflow-overview}$. The flow exporter reads the \ac{IP} packets that cross its boundary to generate flow-records. The flow-records are exported based on some predefined expiration rules, such as a \ac{TCP} \texttt{FIN} or \texttt{RST}, an inactivity timeout, a regular export timeout or crossing a low memory threshold. To achieve efficiency when handling large amounts of traffic, the flow-records are encapsulated in \ac{UDP} datagrams \marginpar{protocol operation} and are deleted from the exporter once transmitted. On the other end, the collector on receiving these flow-records, decodes and stores them locally to be used for further processing. 

The NetFlow version history is summarized in table $\ref{tab:netflow-versions}$. NetFlow v$1$ was introduced in the $90$s, however it was only until v$5$ with the introduction of \ac{CIDR} and \ac{AS} support that the \marginpar{version history} technology got mainstream. Today, NetFlow v$9$ is the de-facto industry standard and is the bases for \ac{IETF}'s \ac{IPFIX} effort to create a universal specification for \ac{IP} flow-export. 
\begin{table}[h!]
	\begin{center}
		\begin{tabular}{|c|c|}
			\hline	
			version & features \\
			\hline
			\hline 
			v$1, \{2,3,4\}$ & original format with several internal releases \\
			\hline 
			v$5$ & \ac{CIDR}, \ac{AS} support and flow sequence numbers \\
			\hline
			v$\{6,7,8\}$ & router-based aggregation support \\
			\hline
			v$9$ & template-based with \ac{IP}v$6$, and \ac{MPLS} support \\
			\hline
			\ac{IPFIX} & universal standard, transport-protocol agnostic\\
			\hline
		\end{tabular}
	\end{center}
	\caption{NetFlow Version History}
\label{tab:netflow-versions}
\end{table}

NetFlow v$9$ introduces templates in its export format. With templates, the exporter only needs to send required fields to the flow collector thereby reducing the volume of flow-data exported. In addition, fields can be added/removed from the flows without changing the export format. The transmission \marginpar{netflow v$9$} of records encapsulated in \ac{UDP} datagrams can lead to loss of flows when the link is congested and therefore the exporter and collector have usually been restricted to one-hop away dedicated links. To overcome this limitation, NetFlow v$9$ introduces transport support over congestion-aware \ac{SCTP}. In addition, NetFlow v$9$ also provides support for \ac{MPLS} and \ac{IP}v$6$ addresses. 

\marginpar{sampled netflow}
\marginpar{adaptive netflow}
\marginpar{flexible netflow}
\marginpar{flowrank}
\marginpar{information loss or win?}

\section{IPFIX}\label{sec:ipfix}
\section{sFlow}\label{sec:sflow}